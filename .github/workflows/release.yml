# Triggered by a new release, will create new binaries
name: Release workflow

on:
  release:
    types: [published]

jobs:
  check:
    runs-on: "ubuntu-latest"
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Test release version against system version
        run: |
          VER=v$(cat VERSION)
          REL=${{ github.event.release.name }}
          echo "Github release name: $REL"
          echo "AVR-GDB version: $VER"
          if [ "x$VER" != "x$REL" ]; then
             echo "Release version does not match system version"
             exit 1
          fi
          echo "Release and system version are identical, now we continue"

  build:
    needs: check
    strategy:
      matrix:
        runner: ["ubuntu-24.04", "ubuntu-latest" ] # [ "macos-15-intel", "macos-15", "ubuntu-24.04", "ubuntu-24.04-arm", "ubuntu-latest" ]
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install packages
        if: matrix.runner == 'ubuntu-24.04' || matrix.runner == 'ubuntu-24.04-arm' || matrix.runner == 'ubuntu-latest'
        run: |
          sudo apt-get install wget make mingw-w64 bzip2 xz-utils autoconf texinfo libgmp-dev libmpfr-dev libexpat1-dev

      - name: macos-intel
        if: matrix.runner == 'macos-15-intel'
        run: |
          echo "OS=macos" >> $GITHUB_ENV
          echo "ARCH=intel" >> $GITHUB_ENV
          echo "PREF=x86_64-apple-darwin" >> $GITHUB_ENV

      - name: macos-arm
        if: matrix.runner == 'macos-15'
        run: |
          echo "OS=macos" >> $GITHUB_ENV
          echo "ARCH=arm" >> $GITHUB_ENV
          echo "PREF=arm64-apple-darwin" >> $GITHUB_ENV

      - name: linux-intel
        if: matrix.runner == 'ubuntu-24.04'
        run: |
          echo "OS=linux" >> $GITHUB_ENV
          echo "ARCH=intel" >> $GITHUB_ENV
          echo "PREF=x86_64-linux-gnu" >> $GITHUB_ENV

      - name: linux-arm
        if: matrix.runner == 'ubuntu-24.04-arm'
        run: |
          echo "OS=linux" >> $GITHUB_ENV
          echo "ARCH=arm" >> $GITHUB_ENV
          echo "PREF=aarch64-linux-gnu" >> $GITHUB_ENV

      - name: windows
        if: matrix.runner == 'ubuntu-latest'
        run: |
          echo "OS=windows" >> $GITHUB_ENV
          echo "ARCH=intel" >> $GITHUB_ENV
          echo "PREF=x86_64-mingw32" >> $GITHUB_ENV

      - name: patch and build 
        run: |
          ./avr-gdb-build.sh ${{ env.OS }} ${{ env.ARCH }}
          if [[ "{{ env.OS }}" == "windows" ]]; then
             EXT=".exe"
          else
             EXT=""
          fi
          mv build/avr-${{ env.OS }}-${{ env.ARCH }}/bin/avr-gdb${EXT} .
          tar -cvz --exclude="*DS_Store" --exclude="*/._*" -f ${{ env.PREF }}.tar.gz avr-gdb${EXT}

      - name: upload
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PREF }}
          path: ${{ env.PREF }}.tar.gz
          overwrite: true
          if-no-files-found: error